-- 確保表不存在，避免重複創建的錯誤
DROP TABLE IF EXISTS public.calendar;

-- 創建新的資料表結構
CREATE TABLE public.calendar (
    "Id" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY, -- EF Core 預期的 PK 欄位
    "西元年" integer,
    "陽月" integer,
    "陽日" integer,
    "年干支" character varying(50),
    "月干支" character varying(50),
    "日干支" character varying(50),
    "日天干" character varying(50),
    "節氣" character varying(50),
    "陰曆月" character varying(50),
    "陰曆日" character varying(50),
    "星期" character varying(50),
    "季節" character varying(50),
    CONSTRAINT "PK_calendar" PRIMARY KEY ("Id") -- 設定主鍵
);

備份作業
您好！問得好！這些備份和維護的動作，有些需要在您的 本地電腦 上執行，有些則可以直接在 Fly.io 的命令列 中完成。

以下是每個動作的執行位置和詳細說明：

1. 💾 Neon 資料庫備份 (最重要)
這個動作需要您在 本地電腦 上執行，並使用 PostgreSQL 官方提供的工具 pg_dump。

動作	執行位置	說明
安裝工具	您的本地電腦 (Windows)	您需要先安裝 PostgreSQL Client (通常包含 pg_dump)。如果您已經安裝了，可以跳過這一步。
執行備份	您的本地電腦 (PowerShell/CMD)	使用 pg_dump 指令，連線到 Neon 伺服器，將資料庫導出成文件。

匯出到試算表

🛠️ 具體步驟：
確保您已安裝 pg_dump：如果您之前用 psql 連線過資料庫，那應該已經有了。

執行備份指令：請在您的 PowerShell 或 CMD 中執行以下指令（它會要求您輸入密碼 npg_yU61ADFqZcNY）：

PowerShell

# 執行這條指令時，請確保您處於一個想要保存備份檔案的目錄
$env:PGPASSWORD="npg_yU61ADFqZcNY"
pg_dump -h ep-tiny-flower-a1gv6jkf-pooler.ap-southeast-1.aws.neon.tech -U neondb_owner -d neondb -F c -b -v -f "ecanapi_neon_backup_$(Get-Date -Format yyyyMMdd).dump"
$env:PGPASSWORD="" # 清除密碼變數 (安全性考慮)
執行後，您會在當前目錄下看到一個名為 ecanapi_neon_backup_...dump 的檔案，這就是您的數據庫快照。

2. ⚙️ Fly.io 配置備份 (確保快速恢復)
這些動作都是使用 flyctl 工具完成，因此在您的 本地電腦 上的 PowerShell 中執行。

動作	執行位置	說明
備份 Secrets	您的本地電腦 (PowerShell)	獲取並保存您設定的關鍵環境變數。
備份 fly.toml	您的本地電腦	確認並保存您的應用程式配置檔案。

匯出到試算表

🛠️ 具體步驟：
列出並保存 Secrets：

PowerShell

fly secrets list -a ecanapi

PS D:\net8\ecanapi> fly secrets list -a ecanapi
NAME                                    DIGEST
DOCKER_REGISTRY_USER                    88386f6e6245db68
DOCKER_REGISTRY_PASSWORD                fd064ce371523421
ASPNETCORE_ENVIRONMENT                  59b7576afd21697d
ConnectionStrings__DefaultConnection    1b7365292e4f8c30
DATABASE_URL                            1b7365292e4f8c30



請將輸出的完整內容（包含 ConnectionStrings__DefaultConnection 和 DATABASE_URL 的 Key/Value）複製並安全儲存 起來。

保存 fly.toml：

確保您的本地專案目錄下的 fly.toml 檔案是最新的，並將其備份。

3. 🧪 設置健康檢查 (長期監控)
這個動作需要在 本地電腦 上修改 fly.toml 檔案，然後重新部署。

動作	執行位置	說明
修改配置	您的本地電腦	編輯 fly.toml 檔案。
重新部署	您的本地電腦 (PowerShell)	將新的健康檢查配置推送到 Fly.io。

匯出到試算表

🛠️ 具體步驟：
在 fly.toml 中添加健康檢查：

在您的 fly.toml 檔案中，找到您的服務定義（通常是 [[services]] 區塊），並在其中加入一個簡單的 HTTP 健康檢查，檢查 ecanapi 應用程式是否正在回應：

Ini, TOML

[[services.http_checks]]
  interval = "10s"
  timeout = "2s"
  path = "/swagger/index.html" # 或者任何您知道會回應 200 OK 的 API 路徑
執行部署：

PowerShell

fly deploy -a ecanapi
這將告訴 Fly.io 監視您的應用程式，如果它停止回應，Fly.io 會嘗試自動修復或通知您。

建議： 我們先完成 步驟 1 (資料庫備份)，因為這是數據安全的第一道防線。您需要先在本地電腦上執行 pg_dump 指令。